{% extends "inventario/base.html" %}
{% block content %}

<div class="row space-between" style="margin-bottom:12px">
  <div>
    <div class="page-title">Dashboard</div>
    <div class="page-subtitle">Toners + movimientos recientes</div>
  </div>

  <form method="get" class="row" style="gap:10px">
    <input
      name="q"
      value="{{ q }}"
      placeholder="Buscar toner (marca / modelo / código)"
      style="width:320px"
    >
    <button class="btn primary" type="submit">
      <span class="mi">search</span>
      Buscar
    </button>
  </form>
</div>

<div class="grid">
  <!-- ================= TONERS ================= -->
  <div class="card">
    <div class="card-header">
      <h3>Toners</h3>
      <a class="btn" href="/toners/nuevo/">
        <span class="mi">add</span>
        Nuevo
      </a>
    </div>

    <table>
      <thead>
        <tr>
          <th>Marca</th>
          <th>Modelo</th>
          <th>Código</th>
          <th>Stock</th>
        </tr>
      </thead>

      <tbody>
        {% for t in toners %}
          <tr
            onclick="window.location='/movimientos/nuevo/?toner={{ t.id }}'"
            title="Registrar movimiento"
          >
            <td>{{ t.marca }}</td>
            <td>{{ t.modelo }}</td>
            <td class="muted">{{ t.codigo|default:"-" }}</td>

            {# Si tenés minimo en este listado, marca low cuando stock <= minimo #}
            <td>
              <span class="stock {% if t.minimo and t.stock <= t.minimo %}low{% endif %}">
                {{ t.stock }}
              </span>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="muted">No hay toners.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ================= MOVIMIENTOS RECIENTES ================= -->
  <div class="card">
    <div class="card-header">
      <h3>Movimientos recientes</h3>
      <a class="btn" href="/movimientos/nuevo/">
        <span class="mi">add_circle</span>
        Nuevo
      </a>
    </div>

    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Toner</th>
          <th>Cant</th>
          <th>Servicio</th>
        </tr>
      </thead>

      <tbody>
        {% for m in movimientos %}
          <tr>
            <td class="muted">{{ m.fecha|date:"Y-m-d H:i" }}</td>

            <td>
              {% if m.tipo|lower == "entrada" %}
                <span class="chip ok"><span class="mi">south_west</span> Entrada</span>
              {% elif m.tipo|lower == "salida" %}
                <span class="chip danger"><span class="mi">north_east</span> Salida</span>
              {% else %}
                <span class="chip"><span class="mi">info</span> {{ m.tipo }}</span>
              {% endif %}
            </td>

            <td>{{ m.toner.marca }} {{ m.toner.modelo }}</td>
            <td><span class="stock">{{ m.cantidad }}</span></td>
            <td class="muted">{{ m.servicio.nombre|default:"-" }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" class="muted">Sin movimientos.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ================= STOCK BAJO ================= -->
<div class="card" style="margin-top:14px">
  <div class="card-header">
    <h3>Stock bajo</h3>
    <span class="chip warn"><span class="mi">warning</span> Revisar</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Toner</th>
        <th>Stock</th>
        <th>Mínimo</th>
      </tr>
    </thead>

    <tbody>
      {% for t in stock_bajo %}
        <tr>
          <td>{{ t.marca }} {{ t.modelo }}</td>
          <td><span class="stock low">{{ t.stock }}</span></td>
          <td class="muted">{{ t.minimo }}</td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="3" class="muted">Todo OK.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}
